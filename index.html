<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finix</title>
    <meta name="theme-color" content="#1a1a1a"/>
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAgICJuYW1lIjogIkZpbmFuY2Vpcm8gUGVzc29hbCIsDQogICAgInNob3J0X25hbWUiOiAiRmluYW5jZWlybyIsDQogICAgImRlc2NyaXB0aW9uIjogIkdlemVuc2lvbmFkb3IgZGUgZmluYW7Dp2FzIHBlc3NvYWlzIiwNCiAgICAic3RhcnRfdXJsIjogIi4iLA0KICAgICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLA0KICAgICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxYTFiMWEiLA0KICAgICJ0aGVtZV9jb2xvciI6ICIjMWExYjFhIiwNCiAgICAiaWNvbnMiOiBbDQogICAgICAgIHsNCiAgICAgICAgICAgICJzcmMiOiAiaWNvbi0xOTIucG5nIiwNCiAgICAgICAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsDQogICAgICAgICAgICAic2l6ZXMiOiAiMTkyxDE5MiINCiAgICAgICAgfSwNCiAgICAgICAgew0KICAgICAgICAgICAgInNyYyI6ICJpY29uLTUxMi5wbmciLA0KICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwNCiAgICAgICAgICAgICJzaXplcyI6ICI1MTJ4NTEyIg0KICAgICAgICB9DQogICAgXQ0KfQ==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAiklEQVR42u3NQQEAAAQEMFf9q1lV091LAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4dMAAAAW97kAAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAiklEQVR42u3NQQEAAAQEMFf9q1lV091LAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4dMAAAAW97kAAAAABJRU5ErkJggg==">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2c2c2c;
            --primary-color: #4a90e2;
            --text-color: #f0f0f0;
            --income-color: #50e3c2;
            --expense-color: #e3505f;
            --border-color: #444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        main { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        h1 { color: var(--primary-color); font-weight: 500; }
        .card { background-color: var(--surface-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 1rem; }
        input[type="date"]:in-range::-webkit-datetime-edit-year-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-month-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-day-field { color: var(--text-color) !important; }
        button { padding: 10px 20px; border: none; border-radius: 5px; background-color: var(--primary-color); color: #fff; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #5a9ee8; }
        .button-secondary { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .button-secondary:hover { background-color: var(--primary-color); color: #fff; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .view-switcher { display: flex; justify-content: center; margin-bottom: 20px; background-color: var(--surface-color); border-radius: 8px; padding: 5px; }
        .view-switcher button { flex-grow: 1; background-color: transparent; color: var(--text-color); opacity: 0.7; }
        .view-switcher button.active { background-color: var(--primary-color); opacity: 1; }
        .transaction-list { list-style: none; }
        .transaction-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border-color); align-items: center; flex-wrap: wrap; gap: 10px; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-details { flex-grow: 1; }
        .transaction-description { font-weight: 500; }
        .transaction-date { font-size: 0.8em; opacity: 0.7; }
        .transaction-amount-wrapper { display: flex; align-items: center; gap: 15px; }
        .transaction-amount { font-weight: 500; font-size: 1.1em; text-align: right; min-width: 100px; }
        .transaction-balance { font-size: 0.8em; opacity: 0.7; text-align: right; width: 100%; margin-top: 5px; }
        .income { color: var(--income-color); }
        .expense { color: var(--expense-color); }
        .delete-transaction-btn { background-color: transparent; color: #888; border: none; font-size: 1.5rem; line-height: 1; padding: 0 5px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .delete-transaction-btn:hover { background-color: var(--expense-color); color: white; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-size: 0.8em; opacity: 0.7; padding-bottom: 10px; }
        .calendar-day { background-color: #333; border-radius: 5px; min-height: 80px; padding: 5px; font-size: 0.8em; display: flex; flex-direction: column; }
        .calendar-day.other-month { opacity: 0.4; }
        .day-number { font-weight: bold; }
        .day-summary { margin-top: auto; font-size: 0.9em; text-align: right; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { position: relative; background-color: var(--surface-color); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .delete-btn { background-color: transparent; border: 1px solid var(--expense-color); color: var(--expense-color); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; line-height: 1.2; }
        .recurring-item-details { flex-grow: 1; }
        .recurring-item-end-date { font-size: 0.8em; opacity: 0.7; }
    </style>
</head>
<body>

    <main>
        <header><h1>Finix</h1><p>Seu controle financeiro, sempre com voc√™.</p></header>
        <div class="card" id="add-transaction-card">
            <h2>Nova Transa√ß√£o</h2>
            <form id="transaction-form">
                <div class="form-group"><label for="date">Data</label><input type="date" id="date" required></div>
                <div class="form-group"><label for="description">Descri√ß√£o</label><input type="text" id="description" placeholder="Ex: Sal√°rio, Almo√ßo" required></div>
                <div class="form-group"><label for="amount">Valor (use - para despesas)</label><input type="number" step="0.01" id="amount" placeholder="Ex: 1500.00 ou -25.50" required></div>
                <button type="submit">Adicionar</button>
            </form>
        </div>
        <div class="actions">
            <button id="btn-recurring">Gastos Recorrentes</button>
            <button id="btn-export" class="button-secondary">Exportar Dados (JSON)</button>
        </div>
        <div class="card" id="filter-card"><div class="form-group"><label for="filter">Filtrar por descri√ß√£o</label><input type="search" id="filter" placeholder="Ex: Supermercado, Sal√°rio..."></div></div>
        <div class="view-switcher"><button id="btn-flow-view" class="active">Fluxo Cont√≠nuo</button><button id="btn-calendar-view">Calend√°rio</button></div>
        <div id="view-container"></div>
    </main>
    
    <div id="recurring-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h2>Gastos Recorrentes</h2><p>Adicione despesas que se repetem todo m√™s.</p>
            <div id="recurring-list"></div>
            <form id="recurring-form">
                 <div class="form-group"><label for="recurring-description">Descri√ß√£o</label><input type="text" id="recurring-description" placeholder="Ex: Aluguel, Netflix" required></div>
                 <div class="form-group"><label for="recurring-amount">Valor (sempre negativo)</label><input type="number" step="0.01" id="recurring-amount" placeholder="Ex: -1200.00" required></div>
                 <div class="form-group"><label for="recurring-day">Dia do M√™s para cobran√ßa</label><input type="number" id="recurring-day" min="1" max="31" value="1" required></div>
                 <div class="form-group"><label for="recurring-end-date">Data Final (Opcional)</label><input type="date" id="recurring-end-date"></div>
                 <button type="submit">Adicionar Gasto Recorrente</button>
            </form>
        </div>
    </div>

    <script>
    /**
     * @namespace App
     * @description Main application module, encapsulated in an IIFE to avoid global scope pollution.
     */
    (function() {
        'use strict';

        const App = {
            /**
             * @property {object} state - The single source of truth for the application's data.
             */
            state: {
                transactions: [],
                recurringExpenses: [],
                currentView: 'flow',
                calendarDate: new Date(),
                filterQuery: ''
            },
            
            /**
             * @property {object} config - Configuration and constants.
             */
            config: {
                storageKey: 'financePWAData_v5'
            },

            /**
             * @namespace data
             * @description Handles data persistence (localStorage).
             */
            data: {
                save() {
                    localStorage.setItem(App.config.storageKey, JSON.stringify(App.state));
                },
                load() {
                    const data = localStorage.getItem(App.config.storageKey);
                    if (!data) return;
                    
                    const parsedData = JSON.parse(data);
                    if (parsedData.transactions) {
                        parsedData.transactions.forEach(t => t.date = new Date(t.date));
                    }
                    // Update state with loaded data, keeping defaults for any new properties
                    App.state = { ...App.state, ...parsedData };
                }
            },

            /**
             * @namespace logic
             * @description Contains pure business logic functions.
             */
            logic: {
                sortTransactions: (transactions) => transactions.sort((a, b) => new Date(b.date) - new Date(a.date)),
                
                applyRecurringExpenses(applyUntilDate = new Date()) {
                    let needsUpdate = false;
                    App.state.recurringExpenses.forEach(expense => {
                        let firstCheckDate;
                        if (expense.lastApplied) {
                            firstCheckDate = new Date(expense.lastApplied);
                            firstCheckDate.setMonth(firstCheckDate.getMonth() + 1);
                        } else {
                            const earliestTxDate = App.state.transactions.length > 0 ? [...App.state.transactions].sort((a, b) => a.date - b.date)[0].date : new Date();
                            firstCheckDate = new Date(Math.min(new Date(), earliestTxDate));
                        }
                        firstCheckDate.setDate(1);

                        while (firstCheckDate <= applyUntilDate) {
                            const transactionDate = new Date(firstCheckDate.getFullYear(), firstCheckDate.getMonth(), expense.day, 12, 0, 0);
                            if (expense.endDate && transactionDate > new Date(expense.endDate + 'T23:59:59-03:00')) {
                                firstCheckDate.setMonth(firstCheckDate.getMonth() + 1);
                                continue;
                            }
                            const alreadyExists = App.state.transactions.some(t => t.recurringId === expense.id && t.date.getFullYear() === transactionDate.getFullYear() && t.date.getMonth() === transactionDate.getMonth());
                            if (!alreadyExists) {
                                App.state.transactions.push({ id: Date.now() + Math.random(), date: transactionDate, description: expense.description, amount: expense.amount, recurringId: expense.id });
                                expense.lastApplied = transactionDate.toISOString();
                                needsUpdate = true;
                            }
                            firstCheckDate.setMonth(firstCheckDate.getMonth() + 1);
                        }
                    });
                    if (needsUpdate) {
                        App.logic.sortTransactions(App.state.transactions);
                    }
                    return needsUpdate;
                },

                formatCurrency: (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
            },
            
            /**
             * @namespace ui
             * @description Handles all DOM interactions and rendering.
             */
            ui: {
                elements: {},
                
                cacheDOMElements() {
                    this.elements = {
                        dateInput: document.getElementById('date'),
                        viewContainer: document.getElementById('view-container'),
                        btnFlowView: document.getElementById('btn-flow-view'),
                        btnCalendarView: document.getElementById('btn-calendar-view'),
                        recurringModal: document.getElementById('recurring-modal'),
                        recurringForm: document.getElementById('recurring-form'),
                        recurringList: document.getElementById('recurring-list'),
                        filterCard: document.getElementById('filter-card'),
                        filterInput: document.getElementById('filter'),
                        transactionForm: document.getElementById('transaction-form'),
                        exportButton: document.getElementById('btn-export'),
                        recurringButton: document.getElementById('btn-recurring'),
                        modalCloseButton: document.querySelector('.close-button'),
                    };
                },

                templates: {
                    transactionItem(t, balance) {
                        return `
                            <div class="transaction-details">
                                <div class="transaction-description">${t.description} ${t.recurringId ? 'üîÅ' : ''}</div>
                                <div class="transaction-date">${t.date.toLocaleDateString('pt-BR')}</div>
                            </div>
                            <div class="transaction-amount-wrapper">
                                <div class="transaction-amount">
                                    <span class="${t.amount > 0 ? 'income' : 'expense'}">${App.logic.formatCurrency(t.amount)}</span>
                                    <div class="transaction-balance">Saldo: ${App.logic.formatCurrency(balance)}</div>
                                </div>
                                <button class="delete-transaction-btn" data-id="${t.id}" title="Remover transa√ß√£o">&times;</button>
                            </div>`;
                    },
                    recurringItem(exp) {
                        const endDateText = exp.endDate ? `Termina em ${new Date(exp.endDate + 'T00:00:00-03:00').toLocaleDateString('pt-BR')}` : '';
                        return `
                            <div class="recurring-item-details">
                                <span>${exp.description} (${App.logic.formatCurrency(exp.amount)}) - Dia ${exp.day}</span>
                                <div class="recurring-item-end-date">${endDateText}</div>
                            </div>
                            <button class="delete-btn" data-id="${exp.id}">Remover</button>`;
                    },
                },

                renderFlowView() {
                    const { viewContainer } = this.elements;
                    viewContainer.innerHTML = '';
                    const list = document.createElement('ul');
                    list.className = 'transaction-list card';

                    let balance = 0;
                    const sortedForBalance = [...App.state.transactions].sort((a, b) => a.date - b.date);
                    const balanceMap = new Map();
                    sortedForBalance.forEach(t => { balance += t.amount; balanceMap.set(t.id, balance); });

                    const filteredTransactions = App.state.filterQuery ?
                        App.state.transactions.filter(t => t.description.toLowerCase().includes(App.state.filterQuery.toLowerCase())) :
                        App.state.transactions;

                    if (filteredTransactions.length === 0) {
                        list.innerHTML = `<p style="text-align: center; padding: 20px;">${App.state.filterQuery ? 'Nenhuma transa√ß√£o encontrada.' : 'Nenhuma transa√ß√£o registrada.'}</p>`;
                    } else {
                        list.innerHTML = filteredTransactions.map(t => {
                            const item = document.createElement('li');
                            item.className = 'transaction-item';
                            item.innerHTML = this.templates.transactionItem(t, balanceMap.get(t.id));
                            return item.outerHTML;
                        }).join('');
                    }
                    viewContainer.appendChild(list);
                },

                renderCalendarView() {
                    const { viewContainer, calendarDate } = this.elements;
                    viewContainer.innerHTML = '';
                    
                    const year = App.state.calendarDate.getFullYear();
                    const month = App.state.calendarDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);

                    App.logic.applyRecurringExpenses(lastDay);

                    let html = `<div class="calendar-controls"><button id="prev-month">&lt;</button><h2>${firstDay.toLocaleString('pt-BR',{month:'long',year:'numeric'})}</h2><button id="next-month">&gt;</button></div><div class="calendar-grid">`;
                    const daysOfWeek = ['D','S','T','Q','Q','S','S'];
                    html += daysOfWeek.map(d => `<div class="calendar-header">${d}</div>`).join('');
                    
                    for (let i = 0; i < firstDay.getDay(); i++) html += `<div class="calendar-day other-month"></div>`;
                    
                    for (let day = 1; day <= lastDay.getDate(); day++) {
                        const dailyTransactions = App.state.transactions.filter(t => t.date.getFullYear() === year && t.date.getMonth() === month && t.date.getDate() === day);
                        const dailyTotal = dailyTransactions.reduce((sum, t) => sum + t.amount, 0);
                        html += `
                            <div class="calendar-day">
                                <div class="day-number">${day}</div>
                                <div class="day-summary">
                                    ${dailyTotal > 0 ? `<div class="income">${App.logic.formatCurrency(dailyTotal)}</div>`:''}
                                    ${dailyTotal < 0 ? `<div class="expense">${App.logic.formatCurrency(dailyTotal)}</div>`:''}
                                </div>
                            </div>`;
                    }
                    html += `</div>`;
                    viewContainer.innerHTML = `<div class="card">${html}</div>`;
                },

                renderRecurringList() {
                    const { recurringList } = this.elements;
                    recurringList.innerHTML = '';
                    
                    if (App.state.recurringExpenses.length === 0) {
                        recurringList.innerHTML = `<p style="opacity: 0.7; text-align: center; margin: 15px 0;">Nenhum gasto recorrente.</p>`;
                    } else {
                         recurringList.innerHTML = App.state.recurringExpenses
                            .sort((a,b) => a.day - b.day)
                            .map(exp => {
                                const item = document.createElement('div');
                                item.className = 'transaction-item';
                                item.innerHTML = this.templates.recurringItem(exp);
                                return item.outerHTML;
                             }).join('');
                    }
                },
                
                toggleModal(show) {
                    this.elements.recurringModal.style.display = show ? 'block' : 'none';
                    if (show) this.renderRecurringList();
                },

                updateViewButtons() {
                    this.elements.btnFlowView.classList.toggle('active', App.state.currentView === 'flow');
                    this.elements.btnCalendarView.classList.toggle('active', App.state.currentView === 'calendar');
                    this.elements.filterCard.style.display = App.state.currentView === 'flow' ? 'block' : 'none';
                },

                render() {
                    this.updateViewButtons();
                    if (App.state.currentView === 'flow') this.renderFlowView();
                    else this.renderCalendarView();
                }
            },
            
            /**
             * @namespace events
             * @description Handles all event listeners and user interactions.
             */
            events: {
                handleTransactionSubmit(e) {
                    e.preventDefault();
                    const { dateInput, transactionForm } = App.ui.elements;
                    const date = new Date(transactionForm.date.value + 'T00:00:00-03:00');
                    const description = transactionForm.description.value;
                    const amount = parseFloat(transactionForm.amount.value);
                    
                    App.addTransaction({date, description, amount});
                    transactionForm.reset();
                    dateInput.valueAsDate = new Date();
                },

                handleRecurringSubmit(e) {
                    e.preventDefault();
                    const form = e.target;
                    const description = form['recurring-description'].value;
                    let amount = parseFloat(form['recurring-amount'].value);
                    const day = parseInt(form['recurring-day'].value);
                    const endDate = form['recurring-end-date'].value;

                    App.addRecurringExpense({description, amount, day, endDate});
                    form.reset();
                },

                handleDeleteRecurring(e) {
                    const deleteButton = e.target.closest('.delete-btn');
                    if (deleteButton) {
                        const id = parseInt(deleteButton.dataset.id, 10);
                        App.deleteRecurringExpense(id);
                    }
                },
                
                handleDeleteTransaction(e) {
                    const deleteButton = e.target.closest('.delete-transaction-btn');
                    if (deleteButton) {
                        const id = parseInt(deleteButton.dataset.id, 10);
                        App.deleteTransaction(id);
                    }
                },

                handleCalendarNav(e) {
                    if (e.target.id === 'prev-month') App.state.calendarDate.setMonth(App.state.calendarDate.getMonth() - 1);
                    if (e.target.id === 'next-month') App.state.calendarDate.setMonth(App.state.calendarDate.getMonth() + 1);
                    App.ui.render();
                },

                bind() {
                    const { elements } = App.ui;
                    elements.transactionForm.addEventListener('submit', this.handleTransactionSubmit);
                    elements.recurringForm.addEventListener('submit', this.handleRecurringSubmit);
                    elements.recurringList.addEventListener('click', this.handleDeleteRecurring);
                    elements.recurringButton.addEventListener('click', () => App.ui.toggleModal(true));
                    elements.modalCloseButton.addEventListener('click', () => App.ui.toggleModal(false));
                    window.addEventListener('click', (e) => { if (e.target === elements.recurringModal) App.ui.toggleModal(false); });
                    elements.viewContainer.addEventListener('click', this.handleDeleteTransaction);
                    elements.viewContainer.addEventListener('click', this.handleCalendarNav);
                    elements.filterInput.addEventListener('input', e => App.setFilter(e.target.value));
                    elements.btnFlowView.addEventListener('click', () => App.setView('flow'));
                    elements.btnCalendarView.addEventListener('click', () => App.setView('calendar'));
                    elements.exportButton.addEventListener('click', () => {
                        const dataStr = JSON.stringify(App.state, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                        const link = document.createElement('a');
                        link.setAttribute('href', dataUri);
                        link.setAttribute('download', `dados_financeiros_${new Date().toISOString().slice(0,10)}.json`);
                        link.click();
                    });
                }
            },
            
            // --- Application Methods (Controllers) ---

            addTransaction({date, description, amount}) {
                if (!description || isNaN(amount)) return alert('Dados da transa√ß√£o inv√°lidos.');
                this.state.transactions.push({ id: Date.now(), date, description, amount, recurringId: null });
                this.logic.sortTransactions(this.state.transactions);
                this.data.save();
                this.ui.render();
            },

            deleteTransaction(id) {
                const tx = this.state.transactions.find(t => t.id === id);
                if (tx && tx.recurringId) return alert('Transa√ß√µes recorrentes devem ser removidas pela regra em "Gastos Recorrentes".');
                if (!confirm('Remover esta transa√ß√£o?')) return;
                this.state.transactions = this.state.transactions.filter(t => t.id !== id);
                this.data.save();
                this.ui.render();
            },

            addRecurringExpense({description, amount, day, endDate}) {
                if (amount > 0) amount = -amount;
                if (!description || isNaN(amount) || isNaN(day)) return alert('Dados do gasto recorrente inv√°lidos.');
                this.state.recurringExpenses.push({ id: Date.now(), description, amount, day, endDate: endDate || null, lastApplied: null });
                if (this.logic.applyRecurringExpenses()) {
                    this.data.save();
                    this.ui.render();
                } else {
                    this.data.save();
                }
                this.ui.renderRecurringList();
            },

            deleteRecurringExpense(id) {
                if (!confirm('Deseja remover esta regra e TODAS as suas transa√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) return;
                this.state.transactions = this.state.transactions.filter(t => t.recurringId !== id);
                this.state.recurringExpenses = this.state.recurringExpenses.filter(exp => exp.id !== id);
                this.data.save();
                this.ui.renderRecurringList();
                this.ui.render();
            },
            
            setView(view) {
                this.state.currentView = view;
                if (view === 'calendar') {
                     this.state.filterQuery = '';
                     this.ui.elements.filterInput.value = '';
                }
                this.ui.render();
            },
            
            setFilter(query) {
                this.state.filterQuery = query.toLowerCase();
                this.ui.render();
            },

            /**
             * @function init
             * @description Initializes the application.
             */
            init() {
                this.ui.cacheDOMElements();
                this.data.load();
                if (this.logic.applyRecurringExpenses()) {
                    this.data.save();
                }
                this.logic.sortTransactions(this.state.transactions);
                this.events.bind();
                this.ui.elements.dateInput.valueAsDate = new Date();
                this.ui.render();

                // PWA Registration
                if ('serviceWorker' in navigator) {
                    const swContent = `const CACHE_NAME = 'finance-pwa-cache-v1'; const urlsToCache = ['./']; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache)))); self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));`;
                    const swBlob = new Blob([swContent], {type: 'application/javascript'});
                    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).then(r => console.log('Service Worker Registrado')).catch(e => console.error('Falha ao registrar Service Worker', e));
                }
            }
        };

        // --- Start the Application ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    })();
    </script>
</body>
</html>